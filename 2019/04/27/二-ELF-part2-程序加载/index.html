<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content>
  <meta name="author" content="Soul Attacker">
  <!-- Open Graph Data -->
  <meta property="og:title" content="(二)ELF_part2_程序链接">
  <meta property="og:description" content="PWN JOURNEY">
  <meta property="og:site_name" content="Soul Attacker PWN Time">
  <meta property="og:type" content="article">
  <meta property="og:image" content="http://yoursite.com">
  
    <link rel="alternate" href="/atom.xml" title="Soul Attacker PWN Time" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Soul Attacker PWN Time</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">(二)ELF_part2_程序链接</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/SoulAttacker">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:740196508@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Soul Attacker</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2019-04-27</span>
            <span class="time">23:23:54</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/ELF/">ELF</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/foundation/">#foundation</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <blockquote>
<p>引自 <a href="https://ctf-wiki.github.io/ctf-wiki/executable/elf/program-linking/" target="_blank" rel="noopener">ctf-wiki</a></p>
</blockquote>
<h1 id="程序链接"><a href="#程序链接" class="headerlink" title="程序链接"></a>程序链接</h1><h2 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h2><h2 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h2><p>动态链接主要是程序<strong>初始化</strong>时或者<strong>程序执行</strong>的过程中<strong>解析变量</strong>或者<strong>函数的引用</strong>。ELF 文件中<strong>某些节区</strong>以及<strong>头部元素</strong>就与动态链接有关。动态链接的模型由<strong>操作系统</strong>定义并实现。</p>
<h3 id="Dynamic-Linker"><a href="#Dynamic-Linker" class="headerlink" title="Dynamic Linker"></a>Dynamic Linker</h3><p>动态链接器可以用来帮助<strong>加载应用所需要的库</strong>并<strong>解析库</strong>所导出的动态符号（函数和全局变量）。</p>
<p>使用<strong>动态链接</strong>来构造程序时，<strong>链接编辑器</strong>在可执行文件的程序头部添加一个<code>PT_INTERP</code> 类型的元素，以便告诉系统将动态链接器作为程序解释器调用。</p>
<blockquote>
<p>Attention：对于系统提供的动态链接器，不同的系统会不同。</p>
</blockquote>
<p><strong>可执行程序</strong>和<strong>动态链接器</strong>会合作起来为程序<strong>创建进程镜像</strong>，具体的细节如下：</p>
<ol>
<li>将<strong>共享目标文件</strong>的<strong>内存段</strong>添加到<strong>进程镜像</strong>中。</li>
<li>为<strong>可执行文件</strong>以及<strong>共享目标文件</strong>进行<strong>重定位</strong>。</li>
<li>如果传递给了<strong>动态链接器</strong>一个<strong>文件描述符</strong>的话，就将其关闭。</li>
<li>将<strong>控制权</strong>传递给程序。</li>
</ol>
<p><strong>链接编辑器</strong>同样也创建了各种各样的数据来<strong>协助动态链接器</strong>来处理<strong>可执行文件和共享目标文件</strong></p>
<p><strong>EX:</strong></p>
<ul>
<li>类型为 <strong>SHT_DYNAMIC</strong> 的节<strong>. dynamic</strong> 包含了各种各样的数据，在这个节的开始处<strong>包含了其它动态链接</strong>的信息。</li>
<li>类型为 <strong>SHT_HASH</strong> 的<strong>节. hash</strong> 包含了<strong>符号哈希表</strong>。</li>
<li>类型为 <strong>SHT_PROGBITS</strong> 的<strong>节. got</strong> 以及<strong>. plt</strong> 包含了两个独立的表：<strong>全局偏移表，过程链接表</strong>。程序会利用过程链接表来处理<strong>地址独立代码</strong>。</li>
</ul>
<p>因为所有的 <code>UNIX System V</code> 都会从一个<strong>共享目标文件</strong>中<strong>导入基本的系统服务</strong>，动态链接器会参与到每一个 <strong>TIS ELF-conforming</strong> 的程序执行过程中。</p>
<p>正如程序加载中所说的，共享目标文件中可能会占用与程序头部中记录的不一样的虚拟地址。动态链接器会在程序拿到控制权前，重定位内存镜像，更新绝对地址。</p>
<p>如果进程的环境中有名叫 LD_BIND_NOW 的非空值，那么动态连接器在把权限传递给程序时，会执行所有的重定位。</p>
<h3 id="Function-Address"><a href="#Function-Address" class="headerlink" title="Function Address"></a>Function Address</h3><p>可执行文件中的函数的地址引用和共享目标中与其相关的引用可能并不会被解析为一个值。共享目标文件中对应的引用将会被动态链接器解析到函数本身对应的虚拟地址处。可执行文件中对应的引用（来自于共享目标文件）将会被链接编辑器解析为过程链接表中对应函数的项中的地址。</p>
<p>如果一个可执行文件引用了一个定义在共享目标文件中的函数，那么链接编辑器就会把相应函数的过程链接表项放到与它关联的符号表表项中。动态链接器会对这种符号表项进行特殊的处理。如果动态链接器在寻找一个符号，并且遇到了一个符号表项在可执行文件中的符号</p>
<ol>
<li>如果符号表项的<code>st_shndx</code> 不是<code>SHN_UNDEF</code> ，动态链接器就会找到这个符号的定义，并且使用它的 st_value 来作为符号的地址。</li>
<li>如果<code>st_shndx</code> 是<code>SHN_UNDEF</code> 并且符号的类型是<code>STT_FUNC</code> ，而且<code>st_value</code> 成员不是 0，动态链接器就会把这个表项视为特殊的，并且使用<code>st_value</code> 的值作为符号的地址。</li>
<li>否则，动态链接器就会认为在可执行文件中的符号是未定义的，然后继续处理。</li>
</ol>
<p>一些重定位与过程链接表的表项相关。</p>
<h3 id="Shared-Object-Dependencies"><a href="#Shared-Object-Dependencies" class="headerlink" title="Shared Object Dependencies"></a>Shared Object Dependencies</h3><p>当链接编辑器在处理一个归档库的时候，它会提取出库成员并且把它们拷贝到输出目标文件中。共享目标文件同时也提供了服务，动态链接器必须将合适的共享目标文件 attach 到进程镜像中，以便于执行。So,可执行文件以及共享目标文件会专门描述他们的依赖关系。</p>
<p>动态链接器为一个目标文件创建内存段时，在 DT_NEEDED 项中描述的依赖给出了需要什么依赖文件来支持程序的服务.<->即使一个共享目标文件被引用多次，它最后也只会被动态链接器连接一次。解析符号引用时，动态链接器会使用 BFS（广度优先搜索）来检查符号表。首先，它会检查可执行文件本身的符号表，然后才会按照顺序检查 DT_NEEDED 入口中的符号表，然后才会继续查看下一次依赖，依次类推。共享目标文件必须可以被程序读取，其它权限不一定需要。</-></p>
<p>依赖列表中的名字要么是 DT_SONAME 中的字符串，要么是用于构建对应目标文件的共享目标文件的路径名。</p>
<p> EX: 例如，如果一个链接器使用了一个带有 DT_SONAME 项名字叫做 lib1 的共享目标文件以及一个其他路径名为 / usr/lib/lib2 的共享目标文件，那么可执行文件中将会包含 lib1 以及 / usr/lib/lib2 依赖列表。    </p>
<p>如果一个共享目标文件具有一个或者多个 /，例如 / usr/lib/lib2 或者 directory/file，那么动态链接器会直接使用那个字符串来作为路径的名字。如果名字中没有 /，比如 lib1，那么以下的三种机制给出了共享目标文件搜索的顺序。</p>
<ul>
<li>首先，动态数组标记 DT_RPATH 可能会给出一个包含一系列以: 分割的目录的字符串。例如 /home/dir/lib:/home/dir2/lib: 告诉我们先在<code>/home/dir/lib</code>目录搜索，然后再在<code>/home/dir2/lib</code>搜索，最后在当前目录搜索。</li>
<li>其次，进程环境变量中的名叫 LD_LIBRARY_PATH 的变量包含了一系列上述所说格式的目录，最后可能会有一个;，后面跟着另外一个目录列表后面跟着另外一个目录列表。这里给出一个例子，效果与第一个所说的效果相同</li>
<li>LD_LIBRARY_PATH=/home/dir/lib:/home/dir2/lib:</li>
<li>LD_LIBRARY_PATH=/home/dir/lib;/home/dir2/lib:</li>
<li>LD_LIBRARY_PATH=/home/dir/lib:/home/dir2/lib:;</li>
</ul>
<p>所有的 LD_LIBRARY_PATH 中的目录只会在搜索完 DT_RPATH 才会进行搜索。</p>
<ul>
<li>最后，如果以上两组目录无法定位期望的库，则动态链接器搜索<code>/usr/lib</code> 路径下的库。</li>
</ul>
<blockquote>
<p>为了安全性，对于<strong>set-user 以及 set-group 标识的程序，动态链接器忽略搜索环境变量（例如LD_LIBRARY_PATH），仅仅搜索DT_RPATH指定的目录和/usr/lib。</strong></p>
</blockquote>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        </p><p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

